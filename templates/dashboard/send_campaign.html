<!-- dashboard/send_campaign.html - HatalÄ± satÄ±rlarÄ± dÃ¼zelt -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Kampanya GÃ¶nder - EmailOtomasyon{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4">
    <div class="d-block mb-4 mb-md-0">
        <h2 class="h4">Kampanya GÃ¶nder</h2>
        <p class="mb-0">{{ campaign.name }} kampanyasÄ±nÄ± gÃ¶nderin</p>
    </div>
</div>

<div class="row">
    <div class="col-12 col-lg-8">
        <div class="card border-0 shadow">
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>KampanyayÄ± gÃ¶ndermek Ã¼zeresiniz!</strong> 
                    Bu iÅŸlem geri alÄ±namaz. LÃ¼tfen gÃ¶nderim Ã¶ncesi detaylarÄ± kontrol edin.
                </div>
                
                <form method="post" id="sendForm">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <h6 class="mb-3">GÃ¶nderim Ã–zeti</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <td width="30%"><strong>Kampanya AdÄ±</strong></td>
                                        <td>{{ campaign.name }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Konu</strong></td>
                                        <td>{{ campaign.subject }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Hedef Listeler</strong></td>
                                        <td>
                                            <ul class="mb-0">
                                                {% for mail_list in campaign.mail_lists.all %}
                                                <li>
                                                    {{ mail_list.name }} 
                                                    ({{ mail_list.subscriber_count }} aktif abone)
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Toplam Abone</strong></td>
                                        <td>
                                            <strong class="text-primary">{{ total_subscribers }}</strong> aktif abone
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>GÃ¶nderim ZamanÄ±</strong></td>
                                        <td>
                                            <strong class="text-success">Hemen</strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {% if total_subscribers == 0 %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Hedef listelerde aktif abone bulunamadÄ±!</strong><br>
                        KampanyayÄ± gÃ¶ndermeden Ã¶nce listelere aktif abone ekleyin.
                    </div>
                    {% endif %}
                    
                    <div class="mb-4">
                        <h6 class="mb-3">GÃ¶nderim OnayÄ±</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="confirm1" required {% if total_subscribers == 0 %}disabled{% endif %}>
                            <label class="form-check-label" for="confirm1">
                                Kampanya iÃ§eriÄŸini kontrol ettim ve onaylÄ±yorum
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="confirm2" required {% if total_subscribers == 0 %}disabled{% endif %}>
                            <label class="form-check-label" for="confirm2">
                                Hedef kitlemin bu iÃ§eriÄŸi almak istediÄŸinden eminim
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirm3" required {% if total_subscribers == 0 %}disabled{% endif %}>
                            <label class="form-check-label" for="confirm3">
                                GÃ¶nderim sÄ±nÄ±rlarÄ±mÄ± aÅŸmadÄ±ÄŸÄ±mÄ± biliyorum
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6 class="mb-3">Test GÃ¶nderimi (Ã–nerilir)</h6>
                        <div class="input-group mb-2">
                            <input type="email" class="form-control" placeholder="Test e-posta adresi" id="testEmail" value="{{ request.user.email }}">
                            <button type="button" class="btn btn-outline-primary" onclick="sendTestEmail()" id="testButton">
                                <i class="fas fa-paper-plane me-2"></i>Test GÃ¶nder
                            </button>
                        </div>
                        <div id="testResult" class="mt-2"></div>
                        <div class="form-text">KampanyayÄ± kendinize test e-postasÄ± olarak gÃ¶nderin</div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'campaign_detail' campaign.id %}" class="btn btn-secondary me-md-2">Ä°ptal</a>
                        <button type="submit" class="btn btn-success" id="sendButton" {% if total_subscribers == 0 %}disabled{% endif %}>
                            <i class="fas fa-paper-plane me-2"></i>
                            {% if total_subscribers > 0 %}
                                {{ total_subscribers }} Aboneye GÃ¶nder
                            {% else %}
                                Abone Yok
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow">
            <div class="card-header">
                <h5 class="card-title mb-0">ðŸ“Š GerÃ§ek ZamanlÄ± Ä°statistik</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">Bu Ay GÃ¶nderilen</small>
                    <h5 class="mb-0" id="monthlySent">0</h5>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Kalan GÃ¼nlÃ¼k KotanÄ±z</small>
                    <h5 class="mb-0" id="dailyQuota">1000</h5>
                </div>
                <div class="mb-3">
                    <small class="text-muted">Ortalama AÃ§Ä±lma OranÄ±</small>
                    <h5 class="mb-0" id="avgOpenRate">0%</h5>
                </div>
            </div>
        </div>
        
        <div class="card border-0 shadow mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">ðŸš€ HÄ±zlÄ± Ä°puÃ§larÄ±</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Ã–nce test gÃ¶nderimi yapÄ±n</strong><br>
                        <small class="text-muted">Ä°Ã§erik ve formatÄ± kontrol edin</small>
                    </li>
                    <li class="mb-3">
                        <i class="fas fa-clock text-warning me-2"></i>
                        <strong>DoÄŸru zamanÄ± seÃ§in</strong><br>
                        <small class="text-muted">Hedef kitlenizin aktif saatleri</small>
                    </li>
                    <li class="mb-3">
                        <i class="fas fa-mobile-alt text-info me-2"></i>
                        <strong>Mobil uyumluluk</strong><br>
                        <small class="text-muted">Mobil cihazlarda test edin</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function sendTestEmail() {
    const testEmail = document.getElementById('testEmail').value;
    const testButton = document.getElementById('testButton');
    const testResult = document.getElementById('testResult');
    
    if (!testEmail) {
        testResult.innerHTML = '<div class="alert alert-danger">LÃ¼tfen test e-posta adresini girin</div>';
        return;
    }
    
    testButton.disabled = true;
    testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>GÃ¶nderiliyor...';
    
    fetch(`/dashboard/campaigns/{{ campaign.id }}/test-send/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `test_email=${encodeURIComponent(testEmail)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            testResult.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            testResult.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
        }
    })
    .catch(error => {
        testResult.innerHTML = '<div class="alert alert-danger">Ä°stek hatasÄ±: ' + error + '</div>';
    })
    .finally(() => {
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Test GÃ¶nder';
    });
}

// GerÃ§ek zamanlÄ± istatistikleri yÃ¼kle
function loadRealTimeStats() {
    fetch('/dashboard/api/real-time-stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('monthlySent').textContent = data.monthly_sent || '0';
            document.getElementById('dailyQuota').textContent = data.daily_quota || '1000';
            document.getElementById('avgOpenRate').textContent = data.avg_open_rate || '0%';
        });
}

// Form gÃ¶nderim kontrolÃ¼
document.getElementById('sendForm').addEventListener('submit', function(e) {
    const confirm1 = document.getElementById('confirm1').checked;
    const confirm2 = document.getElementById('confirm2').checked;
    const confirm3 = document.getElementById('confirm3').checked;
    
    if (!confirm1 || !confirm2 || !confirm3) {
        e.preventDefault();
        alert('LÃ¼tfen tÃ¼m onay kutularÄ±nÄ± iÅŸaretleyin');
        return;
    }
    
    const button = document.getElementById('sendButton');
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>GÃ¶nderiliyor...';
});

// Sayfa yÃ¼klendiÄŸinde istatistikleri yÃ¼kle
document.addEventListener('DOMContentLoaded', loadRealTimeStats);
</script>
{% endblock %}